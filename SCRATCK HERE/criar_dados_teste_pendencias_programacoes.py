#!/usr/bin/env python3
"""
Script para criar dados de teste para pend√™ncias e programa√ß√µes
Usa dados reais da API: ordens de servi√ßo, clientes, equipamentos e usu√°rios
"""

import requests
import json
import random
from datetime import datetime, timedelta
import sys

# Configura√ß√µes da API
BASE_URL = "http://localhost:8000"
API_URL = f"{BASE_URL}/api"

# Token de autentica√ß√£o (substitua por um token v√°lido)
AUTH_TOKEN = "seu_token_aqui"

HEADERS = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json"
}

def fazer_requisicao(method, endpoint, data=None):
    """Fun√ß√£o auxiliar para fazer requisi√ß√µes √† API"""
    url = f"{API_URL}{endpoint}"
    
    try:
        if method.upper() == "GET":
            response = requests.get(url, headers=HEADERS)
        elif method.upper() == "POST":
            response = requests.post(url, headers=HEADERS, json=data)
        elif method.upper() == "PUT":
            response = requests.put(url, headers=HEADERS, json=data)
        elif method.upper() == "PATCH":
            response = requests.patch(url, headers=HEADERS, json=data)
        else:
            raise ValueError(f"M√©todo HTTP n√£o suportado: {method}")
        
        if response.status_code in [200, 201]:
            return response.json()
        else:
            print(f"‚ùå Erro na requisi√ß√£o {method} {endpoint}: {response.status_code}")
            print(f"   Resposta: {response.text}")
            return None
            
    except Exception as e:
        print(f"‚ùå Erro na requisi√ß√£o: {e}")
        return None

def buscar_dados_base():
    """Busca dados base da API para criar testes"""
    print("üîç Buscando dados base da API...")
    
    dados = {
        "ordens_servico": [],
        "usuarios": [],
        "clientes": [],
        "equipamentos": [],
        "setores": []
    }
    
    # Buscar ordens de servi√ßo
    print("   üìã Buscando ordens de servi√ßo...")
    os_data = fazer_requisicao("GET", "/os")
    if os_data:
        dados["ordens_servico"] = os_data[:10]  # Limitar a 10 para teste
        print(f"   ‚úÖ {len(dados['ordens_servico'])} ordens de servi√ßo encontradas")
    
    # Buscar usu√°rios
    print("   üë• Buscando usu√°rios...")
    users_data = fazer_requisicao("GET", "/admin/usuarios")
    if users_data:
        dados["usuarios"] = users_data[:20]  # Limitar a 20 para teste
        print(f"   ‚úÖ {len(dados['usuarios'])} usu√°rios encontrados")
    
    # Buscar clientes
    print("   üè¢ Buscando clientes...")
    clientes_data = fazer_requisicao("GET", "/clientes")
    if clientes_data:
        dados["clientes"] = clientes_data[:10]  # Limitar a 10 para teste
        print(f"   ‚úÖ {len(dados['clientes'])} clientes encontrados")
    
    # Buscar equipamentos
    print("   üîß Buscando equipamentos...")
    equipamentos_data = fazer_requisicao("GET", "/equipamentos")
    if equipamentos_data:
        dados["equipamentos"] = equipamentos_data[:10]  # Limitar a 10 para teste
        print(f"   ‚úÖ {len(dados['equipamentos'])} equipamentos encontrados")
    
    # Buscar setores
    print("   üè≠ Buscando setores...")
    setores_data = fazer_requisicao("GET", "/setores")
    if setores_data:
        dados["setores"] = setores_data[:10]  # Limitar a 10 para teste
        print(f"   ‚úÖ {len(dados['setores'])} setores encontrados")
    
    return dados

def criar_apontamento_teste(os_numero, usuario_id):
    """Cria um apontamento de teste para gerar pend√™ncia"""
    print(f"   üìù Criando apontamento para OS {os_numero}...")
    
    apontamento_data = {
        "numero_os": os_numero,
        "cliente": "Cliente Teste",
        "equipamento": "Equipamento Teste",
        "tipo_maquina": "TIPO_TESTE",
        "tipo_atividade": "MANUTENCAO",
        "descricao_atividade": "Atividade de teste",
        "data_inicio": datetime.now().strftime("%Y-%m-%d"),
        "hora_inicio": "08:00",
        "data_fim": datetime.now().strftime("%Y-%m-%d"),
        "hora_fim": "17:00",
        "observacao": "Apontamento criado para teste de pend√™ncia",
        "resultado_global": "PENDENTE",
        "usuario_id": usuario_id
    }
    
    return fazer_requisicao("POST", "/desenvolvimento/os/apontamentos", apontamento_data)

def criar_pendencias_teste(dados):
    """Cria pend√™ncias de teste"""
    print("üìã Criando pend√™ncias de teste...")
    
    if not dados["ordens_servico"] or not dados["usuarios"]:
        print("‚ùå Dados insuficientes para criar pend√™ncias")
        return []
    
    pendencias_criadas = []
    tipos_maquina = ["BOMBA_CENTRIFUGA", "MOTOR_ELETRICO", "COMPRESSOR", "TURBINA", "GERADOR"]
    prioridades = ["BAIXA", "NORMAL", "ALTA", "URGENTE"]
    
    for i in range(5):  # Criar 5 pend√™ncias
        try:
            os = random.choice(dados["ordens_servico"])
            usuario = random.choice(dados["usuarios"])
            
            # Primeiro criar um apontamento para ter origem da pend√™ncia
            apontamento = criar_apontamento_teste(os.get("os_numero", f"TEST{i+1:03d}"), usuario.get("id"))
            
            if not apontamento:
                print(f"   ‚ùå Falha ao criar apontamento para pend√™ncia {i+1}")
                continue
            
            # Criar pend√™ncia via endpoint de apontamento com pend√™ncia
            pendencia_data = {
                "inpNumOS": os.get("os_numero", f"TEST{i+1:03d}"),
                "inpCliente": random.choice(dados.get("clientes", [{"razao_social": "Cliente Teste"}])).get("razao_social", "Cliente Teste"),
                "inpEquipamento": random.choice(dados.get("equipamentos", [{"nome": "Equipamento Teste"}])).get("nome", "Equipamento Teste"),
                "selMaq": random.choice(tipos_maquina),
                "observacao": f"Pend√™ncia de teste #{i+1} - Problema identificado durante manuten√ß√£o",
                "pendencia_descricao": f"Descri√ß√£o detalhada da pend√™ncia {i+1}: Necess√°rio verificar componente X",
                "pendencia_prioridade": random.choice(prioridades),
                "inpData": datetime.now().strftime("%Y-%m-%d"),
                "inpHora": "08:00",
                "inpDataFim": datetime.now().strftime("%Y-%m-%d"),
                "inpHoraFim": "17:00"
            }
            
            resultado = fazer_requisicao("POST", "/apontamentos-pendencia", pendencia_data)
            
            if resultado:
                pendencias_criadas.append(resultado)
                print(f"   ‚úÖ Pend√™ncia {i+1} criada: ID {resultado.get('pendencia_id')}")
            else:
                print(f"   ‚ùå Falha ao criar pend√™ncia {i+1}")
                
        except Exception as e:
            print(f"   ‚ùå Erro ao criar pend√™ncia {i+1}: {e}")
    
    print(f"‚úÖ {len(pendencias_criadas)} pend√™ncias criadas com sucesso")
    return pendencias_criadas

def criar_programacoes_teste(dados):
    """Cria programa√ß√µes de teste"""
    print("üìÖ Criando programa√ß√µes de teste...")
    
    if not dados["ordens_servico"] or not dados["usuarios"] or not dados["setores"]:
        print("‚ùå Dados insuficientes para criar programa√ß√µes")
        return []
    
    programacoes_criadas = []
    
    # Filtrar usu√°rios PCP (assumindo que t√™m privilege_level ADMIN ou SUPERVISOR)
    usuarios_pcp = [u for u in dados["usuarios"] if u.get("privilege_level") in ["ADMIN", "SUPERVISOR"]]
    if not usuarios_pcp:
        usuarios_pcp = dados["usuarios"][:3]  # Usar os primeiros 3 se n√£o houver PCP
    
    for i in range(3):  # Criar 3 programa√ß√µes
        try:
            os = random.choice(dados["ordens_servico"])
            usuario_pcp = random.choice(usuarios_pcp)
            usuario_responsavel = random.choice(dados["usuarios"])
            setor = random.choice(dados["setores"])
            
            inicio_previsto = datetime.now() + timedelta(days=random.randint(1, 7))
            fim_previsto = inicio_previsto + timedelta(days=random.randint(1, 5))
            
            programacao_data = {
                "os_numero": os.get("os_numero", f"PROG{i+1:03d}"),
                "inicio_previsto": inicio_previsto.isoformat(),
                "fim_previsto": fim_previsto.isoformat(),
                "id_setor": setor.get("id", 1),
                "responsavel_id": usuario_responsavel.get("id"),
                "observacoes": f"Programa√ß√£o de teste #{i+1} - Manuten√ß√£o preventiva programada",
                "prioridade": random.choice(["BAIXA", "NORMAL", "ALTA"]),
                "status": "PROGRAMADA"
            }
            
            resultado = fazer_requisicao("POST", "/pcp/programacoes", programacao_data)
            
            if resultado:
                programacoes_criadas.append(resultado)
                print(f"   ‚úÖ Programa√ß√£o {i+1} criada: ID {resultado.get('id')}")
            else:
                print(f"   ‚ùå Falha ao criar programa√ß√£o {i+1}")
                
        except Exception as e:
            print(f"   ‚ùå Erro ao criar programa√ß√£o {i+1}: {e}")
    
    print(f"‚úÖ {len(programacoes_criadas)} programa√ß√µes criadas com sucesso")
    return programacoes_criadas

def main():
    """Fun√ß√£o principal"""
    print("üöÄ Iniciando cria√ß√£o de dados de teste...")
    print("=" * 60)
    
    # Verificar se o servidor est√° rodando
    try:
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        if response.status_code != 200:
            print("‚ùå Servidor n√£o est√° respondendo corretamente")
            sys.exit(1)
    except:
        print("‚ùå N√£o foi poss√≠vel conectar ao servidor")
        print("   Certifique-se de que o servidor est√° rodando em http://localhost:8000")
        sys.exit(1)
    
    # Buscar dados base
    dados = buscar_dados_base()
    
    if not any(dados.values()):
        print("‚ùå Nenhum dado base encontrado. Verifique a API.")
        sys.exit(1)
    
    print("\n" + "=" * 60)
    
    # Criar pend√™ncias
    pendencias = criar_pendencias_teste(dados)
    
    print("\n" + "=" * 60)
    
    # Criar programa√ß√µes
    programacoes = criar_programacoes_teste(dados)
    
    # Resumo final
    print("\n" + "=" * 60)
    print("üìä RESUMO DA CRIA√á√ÉO DE DADOS")
    print("=" * 60)
    print(f"üìã Pend√™ncias criadas: {len(pendencias)}")
    print(f"üìÖ Programa√ß√µes criadas: {len(programacoes)}")
    
    if pendencias:
        print("\nüìã Pend√™ncias:")
        for p in pendencias:
            print(f"   - ID: {p.get('pendencia_id')} | OS: {p.get('numero_os', 'N/A')}")
    
    if programacoes:
        print("\nüìÖ Programa√ß√µes:")
        for p in programacoes:
            print(f"   - ID: {p.get('id')} | Status: {p.get('status', 'N/A')}")
    
    print("\nüéâ Dados de teste criados com sucesso!")
    print("\nPara testar as funcionalidades:")
    print("1. Acesse a aba 'Pend√™ncias' para ver as pend√™ncias criadas")
    print("2. Teste o bot√£o 'Resolver via Apontamento'")
    print("3. Acesse a aba 'Programa√ß√£o' para ver as programa√ß√µes")
    print("4. Teste a cria√ß√£o de apontamentos para OSs com programa√ß√£o")

if __name__ == "__main__":
    main()
